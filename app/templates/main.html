<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ</title>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
<header class="header">
    <div class="header-left">
        <a href="/panel" class="home-link">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
    <div class="header-right">
        <div class="user-menu">
            <span class="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚ñº</span>
            <div class="dropdown">
                <a href="/profile">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                <a href="/logout">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </div>
</header>

<main class="main">
    <aside class="sidebar">
        <button class="add-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <ul class="camera-list" id="cameraList">
            {% for camera in cameras %}
            <li class="camera-item" data-id="{{ camera.id }}" data-name="{{ camera.name }}" data-url="{{ camera.url }}">
                <span>{{ camera.name }}</span>
                <button class="settings-dots">‚ãÆ</button>
            </li>
            {% endfor %}
        </ul>
    </aside>

    <section class="content">
        <div class="video-container">
            <video id="cameraStream" autoplay controls>
                <source src="/stream/camera1.m3u8" type="application/x-mpegURL">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HLS.
            </video>
        </div>
    </section>

    <aside class="settings" id="cameraSettings">
        <div class="form-group">
            <label for="modelSelect">–ú–æ–¥–µ–ª–∏</label>
            <select id="modelSelect">
                {% for model in models %}
                <option value="{{ model }}">{{ model }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="thresholdInput">–ü–æ—Ä–æ–≥</label>
            <input type="number" id="thresholdInput" min="0" max="100" value="50">
        </div>
        <div class="form-group">
            <button type="button" class="btn" id="applySettings">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </aside>
</main>

<div class="modal" id="cameraModal">
    <div class="modal-content">
        <h2 id="modalTitle">–ö–∞–º–µ—Ä–∞</h2>
        <form id="cameraForm">
            <div class="form-group">
                <label for="cameraName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã</label>
                <input type="text" id="cameraName" name="cameraName" 
                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required maxlength="100">
            </div>
            <div class="form-group">
                <label for="cameraUrl">–ê–¥—Ä–µ—Å –∫–∞–º–µ—Ä—ã</label>
                <input type="text" id="cameraUrl" name="cameraUrl" 
                placeholder="URL –∞–¥—Ä–µ—Å" required maxlength="250">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn del-btn" id="delCameraForm">–£–¥–∞–ª–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button type="button" class="btn cancel-btn" id="cancelCameraForm">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.querySelector('.username').addEventListener('click', function() {
        document.querySelector('.dropdown').classList.toggle('show');
    });

    const modal = document.getElementById('cameraModal');
    const title = document.getElementById('modalTitle');
    const form = document.getElementById('cameraForm');
    const cameraList = document.getElementById('cameraList');
    const delCameraButton = document.getElementById('delCameraForm');

    document.querySelector('.add-btn').addEventListener('click', function() {
        modal.dataset.mode = "add";
        title.textContent = "–î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–µ—Ä—É";
        form.reset();
        modal.classList.add('show');
        delCameraButton.classList.remove('show');
    });

    async function switchCamera(cameraId) {
        const formData = new FormData();
        formData.append('id', cameraId);

        const response = await fetch('/cameras/settings/get', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.success) {
            const select = document.getElementById("modelSelect");

            for (let option of select.options) {
                if (option.value === result.model_name) {
                    option.selected = true;
                    break;
                }
            }

            const thresholdInput = document.getElementById("thresholdInput");
            thresholdInput.value = result.confidence_threshold;

            const cameraSettings = document.getElementById("cameraSettings");
            cameraSettings.dataset.id = cameraId;
        } else {
            alert(result.error)
        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        const li = document.querySelector(".camera-list .camera-item");
        console.log(li);
        if (li) {
            li.classList.add("selected");
            switchCamera(li.dataset.id);
        }
    });

    document.getElementById("applySettings").addEventListener("click", async (e) => {
        const cameraSettings = document.getElementById("cameraSettings");
        const select = document.getElementById("modelSelect");
        const thresholdInput = document.getElementById("thresholdInput");

        const formData = new FormData();
        formData.append('id', cameraSettings.dataset.id);
        formData.append('model', select.value);
        formData.append('threshold', thresholdInput.value);

        const response = await fetch('/cameras/settings/set', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (!result.success) {
            alert(result.error);
        }
    });

    cameraList.addEventListener("click", (e) => {
        const target = e.target;
        
        if (target.classList.contains("camera-item")) {
            const li = target.closest("li");

            cameraList.querySelectorAll(".camera-item").forEach(el => el.classList.remove("selected"));
            li.classList.add("selected");

            switchCamera(li.dataset.id)
        } else if (target.classList.contains("settings-dots")) {
            const li = target.closest("li");

            modal.dataset.mode = "edit";
            modal.dataset.cameraId = li.dataset.id;

            modalTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä—É";
            document.getElementById("cameraName").value = li.dataset.name;
            document.getElementById("cameraUrl").value = li.dataset.url;

            modal.classList.add("show");
            delCameraButton.classList.add('show');
        }
    });

    document.getElementById('cancelCameraForm').addEventListener('click', function() {
        modal.classList.remove('show');
    });

    delCameraButton.addEventListener('click', async (e) => {
        e.preventDefault();

        cameraId = modal.dataset.cameraId;

        const formData = new FormData();
        formData.append('id', cameraId);

        const response = await fetch('/cameras/delete', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (result.success) {
            const li = document.querySelector(`li[data-id='${cameraId}']`);
            if (li) {
                li.remove();
                modal.classList.remove('show');
            }
        } else {
            alert(result.error);
        }
    });

    document.getElementById('cameraForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const mode = modal.dataset.mode;
        const name = document.getElementById('cameraName').value;
        const url = document.getElementById('cameraUrl').value;

        if (mode == "add") {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('url', url);

            const response = await fetch('/cameras/add', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if(result.success){
                const li = document.createElement('li');
                li.dataset.id = result.id;
                li.dataset.name = name;
                li.dataset.url = url;
                li.classList.add('camera-item');

                const text = document.createElement('span');
                text.textContent = name;

                const menuBtn = document.createElement('button');
                menuBtn.textContent = "‚ãÆ";
                menuBtn.classList.add("settings-dots");
                
                li.appendChild(text);
                li.appendChild(menuBtn);
                cameraList.appendChild(li);
                modal.classList.remove('show');
            } else {
                alert(result.error);
            }
        } else if (mode == "edit") {
            cameraId = modal.dataset.cameraId;

            const formData = new FormData();
            formData.append('id', cameraId);
            formData.append('name', name);
            formData.append('url', url);

            const response = await fetch('/cameras/update', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                const li = document.querySelector(`li[data-id='${cameraId}']`);
                if (li) {
                    li.dataset.name = name;
                    li.dataset.url = url;
                    li.childNodes[1].textContent = name;
                }
                modal.classList.remove('show');
            } else {
                alert(result.error);
            }
        }
    });
</script>
</body>
</html>